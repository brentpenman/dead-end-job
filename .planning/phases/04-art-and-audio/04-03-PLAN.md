---
phase: 04-art-and-audio
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - js/game.js
  - js/scene.js
  - js/inventory.js
  - js/dialogue.js
  - index.html
  - css/styles.css
autonomous: true

must_haves:
  truths:
    - "Background ambient music plays on a loop during gameplay (office/elevator muzak style)"
    - "Picking up an item plays a pickup sound effect"
    - "Transitioning between rooms plays a door/transition sound effect"
    - "Opening NPC dialogue plays a dialogue-open sound effect"
    - "Audio can be muted/unmuted by the player via a UI toggle"
  artifacts:
    - path: "js/game.js"
      provides: "Audio manager with play, loop, mute/unmute, and sound effect dispatch"
    - path: "index.html"
      provides: "Audio elements or Web Audio API initialization"
    - path: "css/styles.css"
      provides: "Mute/unmute toggle button styling"
  key_links:
    - from: "js/inventory.js"
      to: "js/game.js"
      via: "Game.playSound('pickup') call on item pickup"
      pattern: "playSound.*pickup"
    - from: "js/game.js"
      to: "js/game.js"
      via: "Game.playSound('door') call on scene transition"
      pattern: "playSound.*door"
    - from: "js/dialogue.js"
      to: "js/game.js"
      via: "Game.playSound('dialogue') call on dialogue open"
      pattern: "playSound.*dialogue"
---

<objective>
Add ambient background music and interaction sound effects to bring the game to life with audio. Include a mute toggle so players can control audio. Sound effects fire on key game interactions: item pickup, room transition, and dialogue open.

Purpose: Audio is the final polish layer -- ambient office muzak and satisfying interaction sounds make the game feel complete and professional.
Output: Looping background music, 3 interaction sound effects, and a mute/unmute UI toggle.
</objective>

<execution_context>
@/Users/brent/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brent/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@js/game.js
@js/scene.js
@js/inventory.js
@js/dialogue.js
@index.html
@css/styles.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build audio manager with ambient music and sound effects</name>
  <files>js/game.js, index.html, css/styles.css</files>
  <action>
**Audio Manager (add to js/game.js):**

Add an Audio module inside the Game IIFE. The audio system uses the Web Audio API for sound effects (short, overlapping sounds) and an HTML5 Audio element for background music (long, looping).

Create `Game.Audio` (or inline within the Game IIFE) with:

```
AudioManager = {
  ctx: null,           // AudioContext (lazy-init on first user interaction)
  musicEl: null,       // HTML5 Audio element for background music
  muted: false,
  initialized: false,

  init: function() { ... },
  initOnInteraction: function() { ... },  // Call from first click/keypress
  playMusic: function() { ... },
  stopMusic: function() { ... },
  playSound: function(name) { ... },
  toggleMute: function() { ... }
}
```

**Background music:**
Generate ambient office/elevator muzak using the Web Audio API's OscillatorNode and GainNode. Create a simple procedural music generator:
- Use 2-3 oscillators with sine/triangle waves at quiet volumes
- Play a slow, repeating sequence of notes in a major key (C, E, G, A pattern)
- Very low volume (gain 0.05-0.1) -- subtle background ambiance
- Loop indefinitely
- This avoids needing external audio files (no npm, no fetch to external sites)

Alternative if Web Audio procedural is too complex: Create a simple drone/pad using two detuned oscillators (e.g., 220Hz and 221Hz sine waves) at very low volume, creating a gentle ambient beat frequency. This is simpler and still atmospheric.

**Sound effects (procedural via Web Audio API):**
Each sound is a short synthesized burst -- no external files needed:
- `pickup`: Short rising tone (frequency sweep 300->600Hz over 150ms, sine wave, quick decay). Satisfying "got it" sound.
- `door`: Low whoosh (white noise filtered through a bandpass at 200Hz, 300ms duration, fade in/out). Room transition feel.
- `dialogue`: Soft chime (two quick sine tones at 523Hz and 659Hz, 80ms each, suggesting a "ding" notification).

Each sound function creates a temporary oscillator/noise node, plays it, and lets it self-destruct (disconnect after done).

**Expose on Game object:**
- `Game.playSound = function(name) { AudioManager.playSound(name); }`
- `Game.toggleMute = function() { AudioManager.toggleMute(); }`
- `Game.startMusic = function() { AudioManager.playMusic(); }`

**Lazy initialization:**
Web Audio requires user gesture. In `Game.startGame()` (called when user clicks "New Game"), call `AudioManager.initOnInteraction()` which creates the AudioContext and starts music. This ensures the first user click enables audio.

**Mute/unmute toggle button:**
In index.html, add a mute button element:
```html
<button id="mute-toggle" title="Toggle Sound">&#x1f50a;</button>
```

In css/styles.css, style #mute-toggle:
- Position: fixed, top-right corner (top: 10px, right: 10px)
- Small circular button (40x40px, border-radius: 50%)
- Semi-transparent dark background
- z-index: 30 (above everything)
- Shows speaker icon (&#x1f50a;) when unmuted, muted icon (&#x1f507;) when muted
- Hover effect

Wire button click to `Game.toggleMute()`. Toggle updates button text/icon and sets `AudioManager.muted`. When muted, set gain to 0. When unmuted, restore gain.

**Important constraints:**
- No external audio files -- all sound is procedural Web Audio API
- No npm, no fetch to external CDNs
- Must work in modern Chrome/Safari/Firefox
- Audio must not autoplay (requires user gesture per browser policy)
  </action>
  <verify>
Open index.html. Click "New Game" -- ambient music should start (very subtle background). Navigate between rooms -- "door" sound should play. Pick up an item -- "pickup" sound. Talk to NPC -- "dialogue" chime. Click mute button -- all audio stops. Click again -- audio resumes. Check console for no errors.
  </verify>
  <done>
Procedural ambient music loops during gameplay. Three distinct sound effects play on pickup, room transition, and dialogue open. Mute toggle works. No external audio files needed. No console errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire sound effects into game interaction points</name>
  <files>js/scene.js, js/inventory.js, js/dialogue.js, js/game.js</files>
  <action>
Add `Game.playSound()` calls at each interaction point:

**Room transition (js/game.js):**
In `Game.changeScene()`, call `Game.playSound('door')` at the start of the transition (when fade-out begins). This plays the whoosh as the scene fades.

**Item pickup (js/inventory.js):**
In the `Inventory.pickUp()` function, after successfully adding the item to inventory, call `Game.playSound('pickup')`. Only play if the item was actually added (not a duplicate).

**Dialogue open (js/dialogue.js):**
In the `Dialogue.open()` function, after the dialogue container becomes visible, call `Game.playSound('dialogue')`. Only play on initial open, not on node transitions within the same dialogue.

**Guard all playSound calls:**
Wrap each call in a check: `if (Game.playSound) Game.playSound('name');` -- this prevents errors if the audio system hasn't initialized yet or if audio module loading order differs.

**Start music on game start:**
In `Game.startGame()`, after removing the title overlay and calling changeScene, call `Game.startMusic()` if it exists. Music should fade in gently (use gain ramp from 0 to target over 1 second).

**Stop music on ending:**
In `Game.triggerEnding()`, stop the background music (or fade it out) and optionally play a special "completion" chime -- a pleasant ascending arpeggio (C-E-G-C, each 100ms, sine wave) to reward the player.
  </action>
  <verify>
Play through the full game:
1. Click "New Game" -- ambient music starts
2. Click any examine hotspot -- no sound (examine is visual only)
3. Pick up bent paperclip -- "pickup" sound plays
4. Use paperclip on ticket machine -- no sound (use-on-hotspot is not a pickup)
5. Navigate to Front Desk -- "door" sound plays on transition
6. Talk to Clerk -- "dialogue" chime on open
7. Complete puzzle chain through to ending -- music stops, completion chime plays
8. No double-plays, no errors
  </verify>
  <done>
Sound effects fire at exactly 3 interaction types: pickup, door transition, dialogue open. Music starts on New Game, stops on ending. Completion chime plays at game end. All sound calls are guarded against missing audio system. No console errors.
  </done>
</task>

</tasks>

<verification>
1. Open index.html, click New Game -- ambient music begins (subtle, not jarring)
2. Navigate between rooms -- door whoosh sound on each transition
3. Pick up an item -- pickup chime sound
4. Talk to NPC -- dialogue open chime
5. Click mute button (top right) -- all audio stops immediately
6. Click mute button again -- audio resumes
7. Complete game to ending -- music stops, completion sound plays
8. Restart game -- music starts again from New Game
9. No console errors throughout full playthrough
</verification>

<success_criteria>
- Procedural ambient music loops during gameplay (no external audio files)
- 3 interaction sound effects fire correctly (pickup, door, dialogue)
- Mute toggle button works and is accessible in the UI
- Audio starts only after user gesture (browser-compliant)
- Completion chime plays at game ending
- Zero console errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-art-and-audio/04-03-SUMMARY.md`
</output>
