---
phase: 03-puzzle-chain
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - js/rooms.js
  - js/dialogues.js
  - js/game.js
  - js/scene.js
autonomous: true

must_haves:
  truths:
    - "Player can use the bent paperclip on the ticket machine to get a number, unlocking the Clerk conversation"
    - "Player can trade the coffee mug to the Filing Cabinet via dialogue and receive Form 27-B"
    - "Player can pick up the rubber stamp (only visible after Clerk mentions it) and bring both form and stamp to the Manager to trigger the ending"
    - "Player cannot skip ahead -- Clerk requires ticket number before giving directions, stamp is hidden until needed, Manager requires readyToStamp flag, ending only triggers after form is stamped"
  artifacts:
    - path: "js/rooms.js"
      provides: "Puzzle-ready hotspots with acceptsItem, visibility gating, new pickup items"
      contains: "acceptsItem.*bent-paperclip"
    - path: "js/dialogues.js"
      provides: "Dialogue trees with puzzle progression actions and ending trigger"
      contains: "triggerEnding"
    - path: "js/game.js"
      provides: "Puzzle state helper and scene render hook for visibility gating"
      contains: "onSceneRender"
    - path: "js/scene.js"
      provides: "Scene render calls visibility gating hook"
      contains: "onSceneRender"
  key_links:
    - from: "js/rooms.js"
      to: "js/game.js"
      via: "onUseItem callbacks that set flags and give items"
      pattern: "Game\\.setFlag|Game\\.addItem"
    - from: "js/dialogues.js"
      to: "js/game.js"
      via: "dialogue action triggers Game.triggerEnding()"
      pattern: "triggerEnding"
    - from: "js/scene.js"
      to: "js/game.js"
      via: "Scene.render calls Game.onSceneRender for visibility gating"
      pattern: "onSceneRender"
    - from: "js/game.js"
      to: "js/rooms.js"
      via: "onSceneRender hides/shows hotspots based on flags"
      pattern: "getFlag.*rubber-stamp|hasTicketNumber"
---

<objective>
Wire all three inventory puzzles into a gated progression chain so the game is playable end-to-end.

Purpose: This is the core gameplay -- without puzzle logic, the game is just rooms and dialogue with no challenge or story arc.
Output: A fully playable puzzle chain: ticket machine fix -> Clerk conversation -> Filing Cabinet trade -> stamp retrieval -> Manager stamps form -> ending screen.
</objective>

<execution_context>
@/Users/brent/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brent/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@js/rooms.js
@js/dialogues.js
@js/game.js
@js/scene.js
@js/inventory.js
@js/dialogue.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire puzzle hotspots and items in rooms.js + add visibility gating in game.js and scene.js</name>
  <files>js/rooms.js, js/game.js, js/scene.js</files>
  <action>
  **In js/rooms.js:**

  1. **Waiting Room -- add bent paperclip pickup hotspot:**
     Add a new hotspot to the waiting-room scene:
     ```
     {
       id: 'bent-paperclip',
       type: 'pickup',
       x: 48, y: 72, width: 5, height: 6,
       label: 'Bent Paperclip',
       itemId: 'bent-paperclip',
       itemDescription: "A bent paperclip. Somebody's been stress-fiddling. Can't blame them -- eternity is long.",
       itemIcon: null
     }
     ```

  2. **Waiting Room -- wire ticket machine to accept bent-paperclip:**
     Update the `ticket-machine` hotspot:
     - Set `acceptsItem: 'bent-paperclip'`
     - Set `useItemText: "I jam the paperclip into the mechanism and... *CLUNK*. It spits out a number. 2,147,483,647. Lucky me."`
     - Set `wrongItemText: "That's not going to unjam a ticket machine."`
     - Add `onUseItem: function() { Game.setFlag('hasTicketNumber', true); }`

  3. **Break Room -- gate rubber stamp visibility:**
     Add a `visibleWhen` property to the `rubber-stamp` hotspot:
     `visibleWhen: { hasFlag: 'clerkSentToManager' }`
     This means the stamp is hidden until the Clerk tells the player to go get it stamped.
     (The visibility gating logic will be handled in game.js/scene.js, but the data flag goes here.)

  4. **Break Room -- wire vending machine to accept coffee-mug for a stuck item:**
     Actually, looking at the puzzle flow, the coffee mug goes to the Filing Cabinet (already wired in dialogue). The vending machine is a red herring / flavor object. Leave it as-is (type: 'use', acceptsItem: null). No change needed.

  5. **Manager's Office -- no hotspot changes needed.** The Manager NPC talk hotspot already exists. Puzzle logic happens in dialogue.

  **In js/game.js:**

  6. **Add `onSceneRender` hook** for visibility gating. Add this method to `window.Game`:
     ```javascript
     onSceneRender: function(sceneId) {
       // Hide hotspots based on puzzle state
       var container = document.getElementById('scene-container');
       var hotspots = container.querySelectorAll('.hotspot');

       hotspots.forEach(function(el) {
         var data = el._hotspotData;
         if (!data) return;

         // Check visibleWhen condition
         if (data.visibleWhen) {
           var visible = true;
           if (data.visibleWhen.hasFlag) {
             visible = !!Game.getFlag(data.visibleWhen.hasFlag);
           }
           if (data.visibleWhen.notFlag) {
             visible = !Game.getFlag(data.visibleWhen.notFlag);
           }
           if (!visible) {
             el.style.display = 'none';
           }
         }

         // Hide pickup hotspots for items already in inventory
         if (data.type === 'pickup' && data.itemId && Game.hasItem(data.itemId)) {
           el.style.display = 'none';
         }
       });
     }
     ```

  **In js/scene.js:**

  7. **Call the `onSceneRender` hook at end of `Scene.render()`:**
     After the hotspot creation loop in `Scene.render()`, add:
     ```javascript
     // Apply visibility gating from game state
     if (Game.onSceneRender) {
       Game.onSceneRender(sceneId);
     }
     ```
     Place this AFTER the `sceneData.hotspots.forEach` block, before the closing of the render function.

  **Important notes:**
  - Do NOT change the `coffee-mug` hotspot -- it is a plain pickup and the trade logic is in the dialogue tree
  - The `bent-paperclip` is a new item that did not exist before -- it's what the player uses to fix the jammed ticket machine
  - The `visibleWhen` property is a new convention -- only the rubber stamp uses it for now
  - The `onUseItem` callback on ticket-machine is called by the existing `Inventory.useOnHotspot()` which already checks for and calls `onUseItem`
  </action>
  <verify>
  Open index.html in a browser. Verify:
  1. Waiting Room shows a "Bent Paperclip" hotspot that can be picked up
  2. Using the bent paperclip on the ticket machine shows success text and the text display says the number
  3. In Break Room, the rubber stamp is NOT visible initially
  4. After getting the Clerk to send you to the Manager (which sets clerkSentToManager), go to Break Room -- rubber stamp IS now visible
  5. Items already picked up do not reappear when re-entering a room
  6. No console errors on any scene transition
  </verify>
  <done>
  - Bent paperclip pickup exists in Waiting Room
  - Ticket machine accepts bent-paperclip and sets hasTicketNumber flag
  - Rubber stamp is hidden until clerkSentToManager flag is set
  - Picked-up items are hidden on re-entry via onSceneRender hook
  - Scene.render() calls Game.onSceneRender() for visibility gating
  </done>
</task>

<task type="auto">
  <name>Task 2: Update dialogue trees for puzzle progression and wire ending trigger</name>
  <files>js/dialogues.js, js/game.js</files>
  <action>
  **In js/dialogues.js:**

  1. **Clerk dialogue -- update 'start' node to gate on puzzle state:**
     The Clerk's start node should change based on progression. Replace the current `start` node with logic that checks flags:
     - If `formStamped` flag is set: show a "done" node (player already completed the game -- shouldn't normally reach here)
     - If player has `form-27b` item: go to `has-form` node (already exists)
     - If `hasTicketNumber` flag: go to `has-number` node (already exists)
     - Default: show the "you need a number" text (current behavior)

     To implement this without changing the dialogue engine, update the `start` node's choices to put conditional choices FIRST (they already are -- `has-number` and `has-form` are conditional). This is already correct. No change to start node needed.

     However, update the `has-form` node action to also set the `clerkSentToManager` flag (it currently only sets it on that node). Actually, looking at the code, `has-form` already sets `clerkSentToManager: true`. Good.

  2. **Manager dialogue -- update 'stamp-form' node to trigger ending:**
     The current `stamp-form` node sets `formStamped: true` but does NOT trigger the ending. Update the `stamp-form` node's action to include a custom action that triggers the ending.

     The dialogue engine's `executeAction` supports `setFlag`, `giveItem`, `removeItem`, `showText`. It does NOT support a custom `triggerEnding` action. Two options:
     - Add `triggerEnding` support to the dialogue engine
     - Use the `goodbye` node (which is the last node after stamp-form) to trigger ending

     **Best approach:** Add a new action type `triggerEnding: true` to the dialogue engine. In `js/dialogue.js`, add to `executeAction`:
     ```javascript
     if (action.triggerEnding) {
       setTimeout(function() {
         Game.triggerEnding();
       }, 500);
     }
     ```
     Wait -- we should NOT modify js/dialogue.js in this task (it's not in our files list). Let me reconsider.

     **Better approach:** Instead, modify the Manager's `goodbye` node to have an action with `triggerEnding: true`, AND add `triggerEnding` support to the dialogue engine in dialogue.js. Actually, let's add dialogue.js to our files.

     **Simplest approach that works:** The `goodbye` node currently has no action and empty choices (so dialogue closes). After dialogue closes, we need the ending to trigger. We can handle this by:
     - Setting a flag `formStamped` in `stamp-form` (already done)
     - In the `goodbye` node, close dialogue normally (empty choices already does this)
     - Add to `Dialogue.close()` in js/dialogue.js: after closing, check if `Game.getFlag('formStamped')` and if so, call `Game.triggerEnding()`

     Actually, the cleanest approach is to add `triggerEnding` as a supported action in the dialogue engine. This touches js/dialogue.js.

     **Final approach -- modify js/dialogues.js AND js/dialogue.js:**

     In `js/dialogues.js`, update the Manager's `goodbye` node:
     ```javascript
     'goodbye': {
       text: "It was SO great meeting you, Morgan! Tell the next plane of existence I said HI! And remember -- every end is just a NEW BEGINNING! ...I need to get out more.",
       choices: [],
       action: { triggerEnding: true }
     }
     ```

     In `js/dialogue.js`, add to the `executeAction` method, after the `showText` block:
     ```javascript
     if (action.triggerEnding) {
       setTimeout(function() {
         Game.triggerEnding();
       }, 500);
     }
     ```

  3. **Manager dialogue -- gate 'stamp-form' correctly:**
     The `stamp-form` choice currently requires `{ hasFlag: 'readyToStamp' }`. We need to SET this flag at the right time. The player should have both `form-27b` (item) AND `rubber-stamp` (item) to be ready.

     The `readyToStamp` flag needs to be set when the player has BOTH items. Since we can't have reactive flag computation, we need a different approach:

     **Change the condition on `stamp-form` choice:** Instead of `hasFlag: 'readyToStamp'`, use two conditions. But the dialogue engine only supports ONE condition per choice.

     **Better approach:** Change the `stamp-form` choice condition to check for the rubber-stamp item (the more gated item), since the player already needs form-27b to see the `have-form-only` path. Update the start node:

     Replace the `stamp-form` choice condition from `{ hasFlag: 'readyToStamp' }` to `{ hasItem: 'rubber-stamp' }`. Then also add a condition check: the stamp-form option should only appear if the player ALSO has form-27b. Since we can only have one condition, and the start node already has a separate `have-form-only` conditional path for having ONLY form-27b:

     **Restructure Manager start node choices:**
     ```javascript
     choices: [
       { text: "I need Form 27-B stamped.", next: 'need-stamp' },
       { text: "How can you be so cheerful?", next: 'cheerful' },
       { text: "Nice office.", next: 'office' },
       { text: "I have the form AND the stamp. Let's do this.", next: 'stamp-form', condition: { hasItem: 'rubber-stamp' } },
       { text: "Here's my Form 27-B.", next: 'have-form-only', condition: { hasItem: 'form-27b' } }
     ]
     ```
     Put `stamp-form` choice BEFORE `have-form-only`. Since the player can only have the stamp after they have the form (progression gating), having `rubber-stamp` implies having `form-27b` too. If the player has the stamp, they see the "form AND stamp" option. If they only have the form (no stamp yet), they see the "form only" option.

     Also update `stamp-form` node action to remove both items:
     ```javascript
     'stamp-form': {
       text: "OH BOY OH BOY! Form AND stamp! This is the BEST day of my afterlife! Let me just... *STAMP* ...APPROVED! You're FREE to go! CONGRATULATIONS!",
       choices: [
         { text: "Finally. Thanks.", next: 'goodbye' }
       ],
       action: {
         removeItem: 'form-27b',
         setFlag: { formStamped: true }
       }
     }
     ```
     Note: We remove `form-27b` but keep `rubber-stamp` (it belongs to the Manager, but for simplicity we can remove it too). Actually, remove BOTH items since they're consumed:
     The dialogue engine's `removeItem` only supports removing ONE item (it's a string, not array). To remove both, we have two options:
     - Remove one in the `stamp-form` action and one in the `goodbye` action
     - Extend executeAction to handle arrays

     **Simplest:** Remove `form-27b` in `stamp-form` action, remove `rubber-stamp` in `goodbye` action:
     ```javascript
     'stamp-form': {
       text: "...*STAMP* ...APPROVED! You're FREE to go! CONGRATULATIONS!",
       choices: [{ text: "Finally. Thanks.", next: 'goodbye' }],
       action: { removeItem: 'form-27b', setFlag: { formStamped: true } }
     },
     'goodbye': {
       text: "It was SO great meeting you...",
       choices: [],
       action: { removeItem: 'rubber-stamp', triggerEnding: true }
     }
     ```

  4. **Clerk dialogue -- ensure re-entry works:**
     Currently, re-opening the Clerk dialogue always shows `start` node. The conditional choices in `start` already handle showing the right options based on flags/items. Verify that:
     - Without `hasTicketNumber`: player sees only "But there's nobody here" and "Where do I even start?"
     - With `hasTicketNumber`: player also sees "I have a number" option
     - With `form-27b` item: player also sees "I have Form 27-B" option
     This is already correctly structured. No change needed.

  5. **Cabinet dialogue -- verify existing trade works:**
     The `offer-coffee` node already: removes coffee-mug, gives form-27b item, sets `gotForm27B` flag. This is complete. No changes needed.

  **In js/dialogue.js:**

  6. **Add `triggerEnding` action support** to `executeAction` method. Add after the `showText` block:
     ```javascript
     if (action.triggerEnding) {
       setTimeout(function() {
         Game.triggerEnding();
       }, 500);
     }
     ```

  **Summary of actual changes needed:**
  - `js/dialogues.js`: Update Manager's `start` choices (reorder, change stamp-form condition to `hasItem: 'rubber-stamp'`), update `stamp-form` action (add `removeItem: 'form-27b'`), update `goodbye` action (add `removeItem: 'rubber-stamp'` and `triggerEnding: true`)
  - `js/dialogue.js`: Add `triggerEnding` action support in `executeAction`
  </action>
  <verify>
  Play through the entire game in browser:
  1. Start at title screen, click New Game
  2. In Waiting Room: pick up bent paperclip, use it on ticket machine -> get number feedback text
  3. Go to Front Desk: talk to Clerk -> "I have a number" option appears -> Clerk gives directions
  4. Go to Break Room: pick up coffee mug. Note: rubber stamp should NOT be visible yet
  5. Go to Filing Room: talk to Cabinet -> "Would a nice cup of coffee help?" option appears -> trade coffee mug for Form 27-B
  6. Go to Front Desk: talk to Clerk -> "I have Form 27-B" option appears -> Clerk says go to Manager
  7. Go to Break Room: rubber stamp IS now visible -> pick it up
  8. Go to Manager's Office: talk to Manager -> "I have the form AND the stamp" option appears -> Manager stamps form -> ending triggers
  9. Ending screen shows with "FORM 27-B: APPROVED" and "Play Again" button
  10. Verify no console errors throughout
  </verify>
  <done>
  - Manager dialogue triggers Game.triggerEnding() after stamping form
  - Manager stamp-form choice gates on hasItem rubber-stamp (not readyToStamp flag)
  - Both form-27b and rubber-stamp are removed from inventory during stamp sequence
  - Dialogue engine supports triggerEnding action
  - Full puzzle chain is playable end-to-end without skipping any step
  </done>
</task>

</tasks>

<verification>
Complete end-to-end playthrough verifying all four success criteria:

1. **PZL-01 (Ticket Machine):** Pick up bent paperclip -> use on ticket machine -> hasTicketNumber flag set -> Clerk "I have a number" choice appears
2. **PZL-02 (Filing Cabinet Trade):** Pick up coffee mug -> talk to Cabinet -> offer coffee -> receive Form 27-B -> Clerk "I have Form 27-B" choice appears
3. **PZL-03 (Stamp Delivery):** After Clerk sends to Manager (clerkSentToManager flag) -> rubber stamp appears in Break Room -> pick up -> talk to Manager -> "form AND stamp" choice -> ending triggers
4. **PZL-04 (Progression Gating):**
   - Without ticket number: Clerk only shows default "need a number" dialogue
   - Without form: Manager only shows "need form" or "need stamp" dialogue
   - Without stamp: rubber-stamp hotspot hidden in Break Room
   - Without both form+stamp: Manager's "stamp-form" choice hidden
   - Items disappear from scenes after pickup (onSceneRender gating)
</verification>

<success_criteria>
- Player can complete the full puzzle chain from start to ending screen
- Each puzzle step requires completing the previous step first
- No console errors during full playthrough
- Rubber stamp only visible after clerkSentToManager flag
- Ending screen triggers after Manager stamps the form
- Play Again button resets all state and returns to title
</success_criteria>

<output>
After completion, create `.planning/phases/03-puzzle-chain/03-01-SUMMARY.md`
</output>
