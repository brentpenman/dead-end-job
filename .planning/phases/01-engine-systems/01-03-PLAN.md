---
phase: 01-engine-systems
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - js/dialogue.js
  - css/dialogue.css
autonomous: true

must_haves:
  truths:
    - "Player clicks an NPC hotspot and a dialogue box opens with the NPC's text and branching choices"
    - "Dialogue choices change based on game state (items held, flags set)"
    - "An NPC portrait area displays during dialogue (placeholder for now)"
    - "Player can exit dialogue at any time by clicking an exit/close option"
  artifacts:
    - path: "js/dialogue.js"
      provides: "Dialogue tree engine with branching, state-aware options, NPC portraits, free exit"
      contains: "Dialogue"
    - path: "css/dialogue.css"
      provides: "Dialogue box layout, NPC portrait area, choice buttons, open/close animation"
      contains: "dialogue"
  key_links:
    - from: "js/dialogue.js"
      to: "js/game.js"
      via: "Dialogue checks Game.hasItem and Game.getFlag to conditionally show choices"
      pattern: "Game\\.(hasItem|getFlag|setFlag)"
    - from: "js/dialogue.js"
      to: "js/scene.js"
      via: "Scene hotspot click dispatches to Dialogue.open for talk-type hotspots"
      pattern: "Dialogue\\.open"
    - from: "js/dialogue.js"
      to: "css/dialogue.css"
      via: "Dialogue.open adds .active class to #dialogue-container to show it"
      pattern: "\\.active"
---

<objective>
Build the dialogue system: clicking NPCs opens a dialogue box with branching choices, state-aware option filtering, NPC portrait display, and free exit.

Purpose: Dialogue trees gate puzzle progression and deliver the game's humor. The Clerk, Filing Cabinet, and Manager all use dialogue to advance the story.
Output: A working dialogue system where the player clicks an NPC, sees dialogue with branching choices that change based on game state, and can exit freely.
</objective>

<execution_context>
@/Users/brent/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brent/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-engine-systems/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dialogue tree engine and UI</name>
  <files>js/dialogue.js, css/dialogue.css</files>
  <action>
**js/dialogue.js:**
Create a window.Dialogue object with:

- Dialogue.trees -- registry object mapping dialogue IDs to dialogue tree data
- Dialogue.currentTree -- the active dialogue tree ID (null when closed)
- Dialogue.currentNode -- the current node ID within the active tree

- Dialogue.register(dialogueId, treeData) -- adds a dialogue tree to the registry

- Dialogue.open(dialogueId) -- opens the dialogue UI:
  1. Sets Dialogue.currentTree = dialogueId
  2. Starts at the tree's "start" node
  3. Shows #dialogue-container by adding .active class
  4. Calls Dialogue.renderNode("start")
  5. Disables hotspot clicks while dialogue is open (add a flag Game.dialogueOpen = true, scene click handler should check this)

- Dialogue.renderNode(nodeId) -- renders a dialogue node:
  1. Looks up node from current tree data
  2. Clears dialogue content area
  3. Sets NPC name in .dialogue-npc-name
  4. Sets portrait placeholder in .dialogue-portrait (use a colored circle with NPC initial for now; the node data has a portrait field for later use)
  5. Sets dialogue text in .dialogue-text (use a typewriter effect: reveal text character by character at ~30ms per char, or show instantly if player clicks during typing)
  6. For each choice in node.choices:
    - Check choice.condition if present -- a function or object that checks game state:
      - {hasItem: "itemId"} -> Game.hasItem("itemId")
      - {hasFlag: "flagName"} -> Game.getFlag("flagName")
      - {notFlag: "flagName"} -> !Game.getFlag("flagName")
      - If condition not met, skip this choice (don't render it)
    - Render a button.dialogue-choice with the choice text
    - On click: execute choice.action if present (can set flags, give items, etc.), then navigate to choice.next node
  7. Always add a "[Leave]" choice at the bottom that calls Dialogue.close() -- UNLESS the node explicitly sets noExit: true (rare, for forced conversations)

- Dialogue.close() -- closes dialogue:
  1. Remove .active from #dialogue-container
  2. Set Game.dialogueOpen = false
  3. Clear Dialogue.currentTree and Dialogue.currentNode
  4. Re-enable hotspot interaction

- Choice action types (choice.action is an object):
  - {setFlag: {key: value}} -> Game.setFlag(key, value)
  - {giveItem: {id, name, description, icon}} -> Game.addItem(item), show pickup text
  - {removeItem: "itemId"} -> Game.removeItem(itemId)
  - {showText: "message"} -> Game.showText(message) after closing

**Dialogue tree data shape:**
```
{
  id: "bob-intro",
  npcName: "Bob",
  portrait: null,  // will be image URL later
  nodes: {
    "start": {
      text: "Hey there. You look... new. And dead. Welcome to the waiting room.",
      choices: [
        { text: "Where am I?", next: "where" },
        { text: "How do I get out of here?", next: "escape" },
        { text: "Nice place you got here.", next: "sarcasm" }
      ]
    },
    "where": {
      text: "The Afterlife Processing Department. Think of it as the DMV, but eternal. Well, hopefully not eternal for you.",
      choices: [
        { text: "How do I get out of here?", next: "escape" },
        { text: "Thanks, I guess.", next: "end" }
      ]
    },
    "escape": {
      text: "You need Form 27-B stamped and approved. Talk to the Clerk at the front desk. Fair warning: she's not exactly... enthusiastic.",
      choices: [
        { text: "Got it. Thanks.", next: "end", action: { setFlag: { talkedToBob: true } } }
      ]
    },
    "sarcasm": {
      text: "Ha. You'll fit right in. Everyone here has been dead long enough to develop a sense of humor. Or lose one.",
      choices: [
        { text: "How do I get out of here?", next: "escape" },
        { text: "I'll figure it out myself.", next: "end" }
      ]
    },
    "end": {
      text: "Good luck. You're gonna need it. Or not. Time is meaningless here.",
      choices: []  // empty choices = only [Leave] button shows
    }
  }
}
```

**Register test dialogue in Game.init():**
- Register the "bob-intro" dialogue tree shown above
- The "npc-bob" hotspot in test-room-a already has dialogueId: "bob-intro" from Plan 01

**Wire the Scene click handler:**
- In scene.js, the "talk" type hotspot click path already checks `typeof Dialogue !== 'undefined'`. Verify it calls Dialogue.open(hotspotData.dialogueId).
- Add a check at the TOP of the scene hotspot click handler: if (Game.dialogueOpen) return; -- prevents clicking hotspots while in dialogue.

**Add a state-conditional choice to test the feature:**
- In the "start" node, add a choice: { text: "Bob, I already know the drill.", next: "end", condition: { hasFlag: "talkedToBob" } }
  This choice only appears after the player has gone through the "escape" path once and set the talkedToBob flag. Verifies state-aware choice filtering.

**Typewriter effect:**
- Dialogue.renderNode shows text character by character at ~30ms intervals
- If player clicks anywhere in the dialogue box during typing, instantly show the full text
- After text is fully revealed, show the choice buttons (choices are hidden during typing)

**css/dialogue.css:**
- #dialogue-container: position absolute, inset 0, display flex, align-items flex-end, justify-content center, background rgba(0,0,0,0.5), opacity 0, pointer-events none, transition opacity 0.3s, z-index 20, padding-bottom 80px (above inventory bar)
- #dialogue-container.active: opacity 1, pointer-events auto
- .dialogue-box: width 80%, max-width 700px, background rgba(30,25,20,0.95), border 2px solid #666, border-radius 8px, padding 0, overflow hidden, display flex, flex-direction row
- .dialogue-portrait: width 120px, min-height 150px, background #333, display flex, align-items center, justify-content center, border-right 2px solid #555, flex-shrink 0
- .dialogue-portrait .portrait-placeholder: width 80px, height 80px, border-radius 50%, background #556, display flex, align-items center, justify-content center, font-size 32px, color white
- .dialogue-content: flex 1, padding 16px, display flex, flex-direction column
- .dialogue-npc-name: font-weight bold, color #ffcc00, font-size 14px, margin-bottom 8px, text-transform uppercase, letter-spacing 1px
- .dialogue-text: color #ddd, font-size 15px, line-height 1.5, min-height 60px, margin-bottom 12px
- .dialogue-choices: display flex, flex-direction column, gap 6px
- .dialogue-choice: background rgba(80,70,50,0.6), border 1px solid #777, border-radius 4px, padding 8px 12px, color #eee, font-size 14px, cursor pointer, text-align left, transition all 0.15s
- .dialogue-choice:hover: background rgba(120,100,60,0.8), border-color #ffcc00, color #fff
- .dialogue-choice.leave-choice: color #999, font-style italic

Create the dialogue-box HTML structure inside #dialogue-container. The structure should be built by Dialogue.init() (called in Game.init()):
- Create the .dialogue-box div
- Inside: .dialogue-portrait (with .portrait-placeholder inside), .dialogue-content (with .dialogue-npc-name, .dialogue-text, .dialogue-choices inside)
- Append to #dialogue-container

Do NOT use ES modules. Attach to window.Dialogue.
  </action>
  <verify>
1. Open index.html -- test-room-a with Bob NPC hotspot
2. Click Bob -- dialogue box fades in at bottom of screen with portrait placeholder (circle with "B"), NPC name "Bob", and typewriter text effect
3. Click during typing -- text completes instantly, choices appear
4. Click "Where am I?" -- navigates to next dialogue node with new text and choices
5. Click "How do I get out of here?" then "Got it. Thanks." -- sets talkedToBob flag
6. Click [Leave] -- dialogue closes, hotspots are interactive again
7. Click Bob again -- dialogue reopens, now shows extra choice "Bob, I already know the drill." (state-aware conditional)
8. While dialogue is open, hotspot clicks outside the dialogue box are ignored
9. No console errors throughout
  </verify>
  <done>Dialogue box opens on NPC click with portrait area, NPC name, typewriter text, and branching choices. Choices conditionally appear based on game flags. Player can exit freely with [Leave]. Dialogue blocks scene interaction while open. State-aware choices verified with talkedToBob flag.</done>
</task>

</tasks>

<verification>
1. NPC click opens dialogue overlay with portrait placeholder and NPC name
2. Typewriter effect reveals text, click-to-skip works
3. Branching choices navigate between dialogue nodes
4. State-conditional choice appears only after flag is set
5. [Leave] button always present (unless noExit), closes dialogue cleanly
6. Scene hotspots are blocked while dialogue is open
7. Dialogue can be re-opened after closing
8. No console errors
</verification>

<success_criteria>
- Clicking talk hotspot opens dialogue box with NPC portrait area, name, and text
- Text displays with typewriter effect, skippable by click
- Branching choices navigate to different nodes
- Conditional choices filter based on Game.hasItem and Game.getFlag
- [Leave] choice always available, closes dialogue
- Scene interaction disabled during dialogue, re-enabled on close
- Action objects (setFlag, giveItem) execute on choice selection
</success_criteria>

<output>
After completion, create `.planning/phases/01-engine-systems/01-03-SUMMARY.md`
</output>
